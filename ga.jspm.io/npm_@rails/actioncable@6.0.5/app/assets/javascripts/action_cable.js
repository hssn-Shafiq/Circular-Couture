var t="undefined"!==typeof globalThis?globalThis:"undefined"!==typeof self?self:global;var n={};(function(t,e){e(n)})(0,(function(n){var e={logger:self.console,WebSocket:self.WebSocket};var o={log:function log(){if((this||t).enabled){var n;for(var o=arguments.length,i=Array(o),r=0;r<o;r++)i[r]=arguments[r];i.push(Date.now());(n=e.logger).log.apply(n,["[ActionCable]"].concat(i))}}};var i="function"===typeof Symbol&&"symbol"===typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"===typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t};var classCallCheck=function(t,n){if(!(t instanceof n))throw new TypeError("Cannot call a class as a function")};var r=function(){function defineProperties(t,n){for(var e=0;e<n.length;e++){var o=n[e];o.enumerable=o.enumerable||false;o.configurable=true;"value"in o&&(o.writable=true);Object.defineProperty(t,o.key,o)}}return function(t,n,e){n&&defineProperties(t.prototype,n);e&&defineProperties(t,e);return t}}();var s=function now(){return(new Date).getTime()};var c=function secondsSince(t){return(s()-t)/1e3};var u=function clamp(t,n,e){return Math.max(n,Math.min(e,t))};var l=function(){function ConnectionMonitor(n){classCallCheck(this||t,ConnectionMonitor);(this||t).visibilityDidChange=(this||t).visibilityDidChange.bind(this||t);(this||t).connection=n;(this||t).reconnectAttempts=0}ConnectionMonitor.prototype.start=function start(){if(!this.isRunning()){(this||t).startedAt=s();delete(this||t).stoppedAt;this.startPolling();addEventListener("visibilitychange",(this||t).visibilityDidChange);o.log("ConnectionMonitor started. pollInterval = "+this.getPollInterval()+" ms")}};ConnectionMonitor.prototype.stop=function stop(){if(this.isRunning()){(this||t).stoppedAt=s();this.stopPolling();removeEventListener("visibilitychange",(this||t).visibilityDidChange);o.log("ConnectionMonitor stopped")}};ConnectionMonitor.prototype.isRunning=function isRunning(){return(this||t).startedAt&&!(this||t).stoppedAt};ConnectionMonitor.prototype.recordPing=function recordPing(){(this||t).pingedAt=s()};ConnectionMonitor.prototype.recordConnect=function recordConnect(){(this||t).reconnectAttempts=0;this.recordPing();delete(this||t).disconnectedAt;o.log("ConnectionMonitor recorded connect")};ConnectionMonitor.prototype.recordDisconnect=function recordDisconnect(){(this||t).disconnectedAt=s();o.log("ConnectionMonitor recorded disconnect")};ConnectionMonitor.prototype.startPolling=function startPolling(){this.stopPolling();this.poll()};ConnectionMonitor.prototype.stopPolling=function stopPolling(){clearTimeout((this||t).pollTimeout)};ConnectionMonitor.prototype.poll=function poll(){var n=this||t;(this||t).pollTimeout=setTimeout((function(){n.reconnectIfStale();n.poll()}),this.getPollInterval())};ConnectionMonitor.prototype.getPollInterval=function getPollInterval(){var n=(this||t).constructor.pollInterval,e=n.min,o=n.max,i=n.multiplier;var r=i*Math.log((this||t).reconnectAttempts+1);return Math.round(1e3*u(r,e,o))};ConnectionMonitor.prototype.reconnectIfStale=function reconnectIfStale(){if(this.connectionIsStale()){o.log("ConnectionMonitor detected stale connection. reconnectAttempts = "+(this||t).reconnectAttempts+", pollInterval = "+this.getPollInterval()+" ms, time disconnected = "+c((this||t).disconnectedAt)+" s, stale threshold = "+(this||t).constructor.staleThreshold+" s");(this||t).reconnectAttempts++;if(this.disconnectedRecently())o.log("ConnectionMonitor skipping reopening recent disconnect");else{o.log("ConnectionMonitor reopening");(this||t).connection.reopen()}}};ConnectionMonitor.prototype.connectionIsStale=function connectionIsStale(){return c((this||t).pingedAt?(this||t).pingedAt:(this||t).startedAt)>(this||t).constructor.staleThreshold};ConnectionMonitor.prototype.disconnectedRecently=function disconnectedRecently(){return(this||t).disconnectedAt&&c((this||t).disconnectedAt)<(this||t).constructor.staleThreshold};ConnectionMonitor.prototype.visibilityDidChange=function visibilityDidChange(){var n=this||t;"visible"===document.visibilityState&&setTimeout((function(){if(n.connectionIsStale()||!n.connection.isOpen()){o.log("ConnectionMonitor reopening stale connection on visibilitychange. visbilityState = "+document.visibilityState);n.connection.reopen()}}),200)};return ConnectionMonitor}();l.pollInterval={min:3,max:30,multiplier:5};l.staleThreshold=6;var p={message_types:{welcome:"welcome",disconnect:"disconnect",ping:"ping",confirmation:"confirm_subscription",rejection:"reject_subscription"},disconnect_reasons:{unauthorized:"unauthorized",invalid_request:"invalid_request",server_restart:"server_restart"},default_mount_path:"/cable",protocols:["actioncable-v1-json","actioncable-unsupported"]};var a=p.message_types,h=p.protocols;var f=h.slice(0,h.length-1);var d=[].indexOf;var g=function(){function Connection(n){classCallCheck(this||t,Connection);(this||t).open=(this||t).open.bind(this||t);(this||t).consumer=n;(this||t).subscriptions=(this||t).consumer.subscriptions;(this||t).monitor=new l(this||t);(this||t).disconnected=true}Connection.prototype.send=function send(n){if(this.isOpen()){(this||t).webSocket.send(JSON.stringify(n));return true}return false};Connection.prototype.open=function open(){if(this.isActive()){o.log("Attempted to open WebSocket, but existing socket is "+this.getState());return false}o.log("Opening WebSocket, current state is "+this.getState()+", subprotocols: "+h);(this||t).webSocket&&this.uninstallEventHandlers();(this||t).webSocket=new e.WebSocket((this||t).consumer.url,h);this.installEventHandlers();(this||t).monitor.start();return true};Connection.prototype.close=function close(){var n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{allowReconnect:true},e=n.allowReconnect;e||(this||t).monitor.stop();if(this.isActive())return(this||t).webSocket.close()};Connection.prototype.reopen=function reopen(){o.log("Reopening WebSocket, current state is "+this.getState());if(!this.isActive())return this.open();try{return this.close()}catch(t){o.log("Failed to reopen WebSocket",t)}finally{o.log("Reopening WebSocket in "+(this||t).constructor.reopenDelay+"ms");setTimeout((this||t).open,(this||t).constructor.reopenDelay)}};Connection.prototype.getProtocol=function getProtocol(){if((this||t).webSocket)return(this||t).webSocket.protocol};Connection.prototype.isOpen=function isOpen(){return this.isState("open")};Connection.prototype.isActive=function isActive(){return this.isState("open","connecting")};Connection.prototype.isProtocolSupported=function isProtocolSupported(){return d.call(f,this.getProtocol())>=0};Connection.prototype.isState=function isState(){for(var t=arguments.length,n=Array(t),e=0;e<t;e++)n[e]=arguments[e];return d.call(n,this.getState())>=0};Connection.prototype.getState=function getState(){if((this||t).webSocket)for(var n in e.WebSocket)if(e.WebSocket[n]===(this||t).webSocket.readyState)return n.toLowerCase();return null};Connection.prototype.installEventHandlers=function installEventHandlers(){for(var n in(this||t).events){var e=(this||t).events[n].bind(this||t);(this||t).webSocket["on"+n]=e}};Connection.prototype.uninstallEventHandlers=function uninstallEventHandlers(){for(var n in(this||t).events)(this||t).webSocket["on"+n]=function(){}};return Connection}();g.reopenDelay=500;g.prototype.events={message:function message(n){if(this.isProtocolSupported()){var e=JSON.parse(n.data),i=e.identifier,message=e.message,r=e.reason,s=e.reconnect,c=e.type;switch(c){case a.welcome:(this||t).monitor.recordConnect();return(this||t).subscriptions.reload();case a.disconnect:o.log("Disconnecting. Reason: "+r);return this.close({allowReconnect:s});case a.ping:return(this||t).monitor.recordPing();case a.confirmation:return(this||t).subscriptions.notify(i,"connected");case a.rejection:return(this||t).subscriptions.reject(i);default:return(this||t).subscriptions.notify(i,"received",message)}}},open:function open(){o.log("WebSocket onopen event, using '"+this.getProtocol()+"' subprotocol");(this||t).disconnected=false;if(!this.isProtocolSupported()){o.log("Protocol is unsupported. Stopping monitor and disconnecting.");return this.close({allowReconnect:false})}},close:function close(n){o.log("WebSocket onclose event");if(!(this||t).disconnected){(this||t).disconnected=true;(this||t).monitor.recordDisconnect();return(this||t).subscriptions.notifyAll("disconnected",{willAttemptReconnect:(this||t).monitor.isRunning()})}},error:function error(){o.log("WebSocket onerror event")}};var b=function extend(t,n){if(null!=n)for(var e in n){var o=n[e];t[e]=o}return t};var v=function(){function Subscription(n){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};var o=arguments[2];classCallCheck(this||t,Subscription);(this||t).consumer=n;(this||t).identifier=JSON.stringify(e);b(this||t,o)}Subscription.prototype.perform=function perform(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};n.action=t;return this.send(n)};Subscription.prototype.send=function send(n){return(this||t).consumer.send({command:"message",identifier:(this||t).identifier,data:JSON.stringify(n)})};Subscription.prototype.unsubscribe=function unsubscribe(){return(this||t).consumer.subscriptions.remove(this||t)};return Subscription}();var m=function(){function Subscriptions(n){classCallCheck(this||t,Subscriptions);(this||t).consumer=n;(this||t).subscriptions=[]}Subscriptions.prototype.create=function create(n,e){var o=n;var r="object"===("undefined"===typeof o?"undefined":i(o))?o:{channel:o};var s=new v((this||t).consumer,r,e);return this.add(s)};Subscriptions.prototype.add=function add(n){(this||t).subscriptions.push(n);(this||t).consumer.ensureActiveConnection();this.notify(n,"initialized");this.sendCommand(n,"subscribe");return n};Subscriptions.prototype.remove=function remove(t){this.forget(t);this.findAll(t.identifier).length||this.sendCommand(t,"unsubscribe");return t};Subscriptions.prototype.reject=function reject(n){var e=this||t;return this.findAll(n).map((function(t){e.forget(t);e.notify(t,"rejected");return t}))};Subscriptions.prototype.forget=function forget(n){(this||t).subscriptions=(this||t).subscriptions.filter((function(t){return t!==n}));return n};Subscriptions.prototype.findAll=function findAll(n){return(this||t).subscriptions.filter((function(t){return t.identifier===n}))};Subscriptions.prototype.reload=function reload(){var n=this||t;return(this||t).subscriptions.map((function(t){return n.sendCommand(t,"subscribe")}))};Subscriptions.prototype.notifyAll=function notifyAll(n){var e=this||t;for(var o=arguments.length,i=Array(o>1?o-1:0),r=1;r<o;r++)i[r-1]=arguments[r];return(this||t).subscriptions.map((function(t){return e.notify.apply(e,[t,n].concat(i))}))};Subscriptions.prototype.notify=function notify(t,n){for(var e=arguments.length,o=Array(e>2?e-2:0),i=2;i<e;i++)o[i-2]=arguments[i];var r=void 0;r="string"===typeof t?this.findAll(t):[t];return r.map((function(t){return"function"===typeof t[n]?t[n].apply(t,o):void 0}))};Subscriptions.prototype.sendCommand=function sendCommand(n,e){var o=n.identifier;return(this||t).consumer.send({command:e,identifier:o})};return Subscriptions}();var y=function(){function Consumer(n){classCallCheck(this||t,Consumer);(this||t)._url=n;(this||t).subscriptions=new m(this||t);(this||t).connection=new g(this||t)}Consumer.prototype.send=function send(n){return(this||t).connection.send(n)};Consumer.prototype.connect=function connect(){return(this||t).connection.open()};Consumer.prototype.disconnect=function disconnect(){return(this||t).connection.close({allowReconnect:false})};Consumer.prototype.ensureActiveConnection=function ensureActiveConnection(){if(!(this||t).connection.isActive())return(this||t).connection.open()};r(Consumer,[{key:"url",get:function get$$1(){return createWebSocketURL((this||t)._url)}}]);return Consumer}();function createWebSocketURL(t){"function"===typeof t&&(t=t());if(t&&!/^wss?:/i.test(t)){var n=document.createElement("a");n.href=t;n.href=n.href;n.protocol=n.protocol.replace("http","ws");return n.href}return t}function createConsumer(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:getConfig("url")||p.default_mount_path;return new y(t)}function getConfig(t){var n=document.head.querySelector("meta[name='action-cable-"+t+"']");if(n)return n.getAttribute("content")}n.Connection=g;n.ConnectionMonitor=l;n.Consumer=y;n.INTERNAL=p;n.Subscription=v;n.Subscriptions=m;n.adapters=e;n.createWebSocketURL=createWebSocketURL;n.logger=o;n.createConsumer=createConsumer;n.getConfig=getConfig;Object.defineProperty(n,"__esModule",{value:true})}));const e=n.Connection,o=n.ConnectionMonitor,i=n.Consumer,r=n.INTERNAL,s=n.Subscription,c=n.Subscriptions,u=n.adapters,l=n.createWebSocketURL,p=n.logger,a=n.createConsumer,h=n.getConfig,f=n.__esModule;export{e as Connection,o as ConnectionMonitor,i as Consumer,r as INTERNAL,s as Subscription,c as Subscriptions,f as __esModule,u as adapters,a as createConsumer,l as createWebSocketURL,n as default,h as getConfig,p as logger};

//# sourceMappingURL=action_cable.js.map